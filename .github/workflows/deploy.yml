name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_api:
        description: "Deploy API"
        required: false
        default: true
        type: boolean
      deploy_front:
        description: "Deploy Frontend"
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  ORG: video-ai-midias
  IMAGE_NAME: farmaeasy-api
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  REMOTE_DIR: /var/www/html/farmaeasy

jobs:
  # ==========================================================================
  # Detect Changes
  # ==========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.changes.outputs.api }}
      front-changed: ${{ steps.changes.outputs.front }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api:
              - 'api/**'
            front:
              - 'front/**'

  # ==========================================================================
  # API CI - Lint & Test
  # ==========================================================================
  api-ci:
    name: API CI
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.api-changed == 'true' ||
      github.event.inputs.deploy_api == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run Ruff Lint
        run: uv run ruff check . --output-format=github

      - name: Run Ruff Format Check
        run: uv run ruff format --check .

      - name: Run Tests
        run: uv run pytest -v --tb=short --cov-fail-under=0
        env:
          REDIS_URL: redis://localhost:6379
          TESTING: "true"
          SECRET_KEY: test-secret-key-for-ci
          ENVIRONMENT: testing

  # ==========================================================================
  # Build & Push Docker Image
  # ==========================================================================
  build-api:
    name: Build API Docker Image
    needs: [detect-changes, api-ci]
    if: |
      always() &&
      (needs.api-ci.result == 'success' || needs.api-ci.result == 'skipped') &&
      (needs.detect-changes.outputs.api-changed == 'true' || github.event.inputs.deploy_api == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./api
          file: ./api/Dockerfile
          target: runtime
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          provenance: false

      - name: Image Summary
        run: |
          echo "### Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Deploy API (Blue/Green)
  # ==========================================================================
  deploy-api:
    name: Deploy API
    needs: [detect-changes, build-api]
    if: |
      always() &&
      needs.build-api.result == 'success' &&
      (needs.detect-changes.outputs.api-changed == 'true' || github.event.inputs.deploy_api == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: production
      url: https://api.farmaeasy.com.br

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy API with Blue/Green
        env:
          IMAGE_TAG: ${{ needs.build-api.outputs.image_tag }}
          REGISTRY: ${{ env.REGISTRY }}
          ORG: ${{ env.ORG }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          echo "Deploying API to production..."
          echo "Image: $REGISTRY/$ORG/$IMAGE_NAME:$IMAGE_TAG"

          # Sync deployment files
          rsync -avz --delete \
            docker-compose.prod.yml \
            blue-green-deploy.sh \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.REMOTE_DIR }}/

          # Sync API .env file (if not exists on server, copy from example)
          rsync -avz \
            --ignore-existing \
            api/.env.example \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.REMOTE_DIR }}/api/.env

          # Execute blue/green deployment on remote server
          ssh ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << EOF
            set -e
            cd ${{ env.REMOTE_DIR }}

            # Ensure scripts are executable
            chmod +x blue-green-deploy.sh

            # Login to GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login $REGISTRY -u ${{ github.actor }} --password-stdin

            # Export environment variables for docker compose
            export REGISTRY="$REGISTRY"
            export ORG="$ORG"
            export IMAGE_NAME="$IMAGE_NAME"
            export IMAGE_TAG="$IMAGE_TAG"

            # Execute blue/green deploy
            ./blue-green-deploy.sh deploy "$IMAGE_TAG"

            # Cleanup old images
            docker system prune -af --filter "until=24h" || true

            echo "API deployment completed!"
          EOF

  # ==========================================================================
  # Frontend CI
  # ==========================================================================
  front-ci:
    name: Frontend CI
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.front-changed == 'true' ||
      github.event.inputs.deploy_front == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: front

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: front/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Biome Lint
        run: npm run lint

      - name: Run TypeScript Check
        run: npm run typecheck

      - name: Run Tests
        run: npm run test -- --run

      - name: Build
        run: npm run build

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: front-dist
          path: front/dist
          retention-days: 1

  # ==========================================================================
  # Deploy Frontend
  # ==========================================================================
  deploy-front:
    name: Deploy Frontend
    needs: [detect-changes, front-ci]
    if: |
      always() &&
      (needs.front-ci.result == 'success') &&
      (needs.detect-changes.outputs.front-changed == 'true' || github.event.inputs.deploy_front == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: production
      url: https://farmaeasy.com.br

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: front-dist
          path: dist

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Frontend
        run: |
          echo "Deploying Frontend to production..."

          # Sync built files to server
          rsync -avz --delete \
            dist/ ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.REMOTE_DIR }}/front/dist/

          echo "Frontend deployment completed!"

  # ==========================================================================
  # Deployment Summary
  # ==========================================================================
  notify:
    name: Deployment Summary
    needs: [deploy-api, deploy-front]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.deploy-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-front.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
